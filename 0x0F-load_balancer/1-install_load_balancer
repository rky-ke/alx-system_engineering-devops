#!/usr/bin/env bash
# Update system packages
apt-get update
apt-get upgrade -y

# Install HAProxy
apt-get install haproxy -y

# Configure HAProxy
cat <<EOL > /etc/haproxy/haproxy.cfg
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend http_frontend
    bind *:80
    mode http
    default_backend http_backend

backend http_backend
    mode http
    balance roundrobin
    server 126591-web-01 100.24.242.252:80 check
    server 126591-web-02 34.207.83.241:80 check
EOL

# Enable HAProxy service
cat <<EOL > /etc/default/haproxy
ENABLED=1
EOL

# Start and enable HAProxy service
systemctl start haproxy
systemctl enable haproxy

